name: Fetch Trains

on:
  schedule:
    - cron: '* * * * *'   # every minute
  workflow_dispatch:        # allow manual trigger

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Deptford departures from Darwin
        env:
          TRAIN_TOKEN: ${{ secrets.TRAIN_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Content-Type: text/xml;charset=UTF-8" \
            -H "SOAPAction: http://thalesgroup.com/RTTI/2017-02-02/ldb/GetDepBoardWithDetails" \
            --data "<?xml version='1.0' encoding='utf-8'?>
          <soap:Envelope xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'
            xmlns:typ='http://thalesgroup.com/RTTI/2013-11-28/Token/types'
            xmlns:ldb='http://thalesgroup.com/RTTI/2017-02-02/ldb/'>
            <soap:Header>
              <typ:AccessToken><typ:TokenValue>${TRAIN_TOKEN}</typ:TokenValue></typ:AccessToken>
            </soap:Header>
            <soap:Body>
              <ldb:GetDepBoardWithDetailsRequest>
                <ldb:numRows>10</ldb:numRows>
                <ldb:crs>DEP</ldb:crs>
              </ldb:GetDepBoardWithDetailsRequest>
            </soap:Body>
          </soap:Envelope>" \
            https://lite.realtime.nationalrail.co.uk/OpenLDBWS/ldb11.asmx > raw.xml

      - name: Convert XML to JSON
        run: |
          python3 - <<'EOF'
          import xml.etree.ElementTree as ET, json
          from datetime import datetime

          with open('raw.xml', 'r', encoding='utf-8') as f:
            raw = f.read()

          print("RAW XML PREVIEW:", raw[:500])

          root = ET.fromstring(raw)

          def gtx(el, tag):
            # wildcard namespace search
            found = el.findall(f'.//*[local-name()="{tag}"]') 
            # ET doesn't support local-name(), so iterate manually
            return None

          def find_all_tag(el, local):
            return [e for e in el.iter() if e.tag.split('}')[-1] == local]

          def find_one_tag(el, local):
            results = find_all_tag(el, local)
            return results[0].text.strip() if results and results[0].text else ''

          services = find_all_tag(root, 'service')
          print(f"Found {len(services)} services")

          trains = []
          for svc in services:
            aimed = find_one_tag(svc, 'std') or find_one_tag(svc, 'sta')
            exp   = find_one_tag(svc, 'etd') or find_one_tag(svc, 'eta') or 'On time'
            dest  = find_one_tag(svc, 'locationName')
            plat  = find_one_tag(svc, 'platform')
            op    = find_one_tag(svc, 'operator')

            cp_names = [e.text.strip() for e in find_all_tag(svc, 'locationName') if e.text]
            # first locationName is the destination itself, rest are calling points
            cp_names = cp_names[1:] if len(cp_names) > 1 else []

            trains.append({
              'aimed': aimed,
              'expected': exp,
              'destination': dest,
              'platform': plat,
              'operator': op,
              'callingPoints': cp_names,
              'cancelled': exp.lower() == 'cancelled'
            })

          out = {
            'updated': datetime.utcnow().strftime('%H:%M'),
            'trains': trains[:10]
          }

          with open('trains.json', 'w') as f:
            json.dump(out, f)

          print(f"Written {len(trains)} trains to trains.json")
          print("Sample:", json.dumps(trains[0] if trains else {}, indent=2))
          EOF

      - name: Commit trains.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add trains.json
          git diff --cached --quiet || git commit -m "chore: update trains $(date -u +'%H:%M')"
          git push
