name: Fetch Trains

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Deptford departures from Darwin
        env:
          TRAIN_TOKEN: ${{ secrets.TRAIN_TOKEN }}
        run: |
          cat > request.xml << XMLEOF
          <?xml version="1.0" encoding="utf-8"?>
          <SOAP-ENV:Envelope
            xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"
            xmlns:ns1="http://thalesgroup.com/RTTI/2021-11-01/ldb/"
            xmlns:ns2="http://thalesgroup.com/RTTI/2010-11-01/ldb/commontypes">
            <SOAP-ENV:Header>
              <ns2:AccessToken>
                <ns2:TokenValue>${TRAIN_TOKEN}</ns2:TokenValue>
              </ns2:AccessToken>
            </SOAP-ENV:Header>
            <SOAP-ENV:Body>
              <ns1:GetDepBoardWithDetailsRequest>
                <ns1:numRows>10</ns1:numRows>
                <ns1:crs>DEP</ns1:crs>
              </ns1:GetDepBoardWithDetailsRequest>
            </SOAP-ENV:Body>
          </SOAP-ENV:Envelope>
          XMLEOF

          echo "=== REQUEST ==="
          cat request.xml

          curl -s -X POST \
            -H "Content-Type: text/xml;charset=UTF-8" \
            --data @request.xml \
            https://lite.realtime.nationalrail.co.uk/OpenLDBWS/ldb12.asmx > raw.xml

          echo "=== RESPONSE ==="
          cat raw.xml

      - name: Convert XML to JSON
        run: |
          python3 - <<'EOF'
          import xml.etree.ElementTree as ET, json
          from datetime import datetime, timezone

          with open('raw.xml', 'r', encoding='utf-8') as f:
            raw = f.read()

          root = ET.fromstring(raw)

          def find_all(el, local):
            return [e for e in el.iter() if e.tag.split('}')[-1] == local]

          def find_one(el, *tags):
            for tag in tags:
              r = find_all(el, tag)
              if r and r[0].text:
                return r[0].text.strip()
            return ''

          # Check for SOAP fault
          faults = find_all(root, 'Fault')
          if faults:
            fs = find_all(root, 'faultstring')
            msg = fs[0].text if fs else 'unknown fault'
            print("SOAP FAULT:", msg)
            json.dump({'updated': datetime.now(timezone.utc).strftime('%H:%M'), 'trains': [], 'error': msg}, open('trains.json','w'))
            exit(0)

          services = find_all(root, 'service')
          print(f"Found {len(services)} services")

          trains = []
          for svc in services:
            aimed = find_one(svc, 'std', 'sta')
            exp   = find_one(svc, 'etd', 'eta') or 'On time'
            dest  = find_one(svc, 'locationName')
            plat  = find_one(svc, 'platform')
            op    = find_one(svc, 'operator')
            cp_names = [
              e.text.strip()
              for cp in find_all(svc, 'callingPoint')
              for e in find_all(cp, 'locationName')
              if e.text
            ]
            trains.append({
              'aimed': aimed,
              'expected': exp,
              'destination': dest,
              'platform': plat,
              'operator': op,
              'callingPoints': cp_names,
              'cancelled': exp.lower() == 'cancelled'
            })
            print(f"  {aimed} -> {dest} ({exp})")

          out = {
            'updated': datetime.now(timezone.utc).strftime('%H:%M'),
            'trains': trains[:10]
          }
          json.dump(out, open('trains.json','w'))
          print(f"Done â€” written {len(trains)} trains")
          EOF

      - name: Commit trains.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add trains.json
          git diff --cached --quiet || git commit -m "chore: update trains $(date -u +'%H:%M')"
          git push
