name: Fetch Trains

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Deptford departures from Darwin
        env:
          TRAIN_TOKEN: ${{ secrets.TRAIN_TOKEN }}
        run: |
          cat > request.xml << XMLEOF
          <?xml version="1.0" encoding="utf-8"?>
          <soap:Envelope
            xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
            xmlns:typ="http://thalesgroup.com/RTTI/2013-11-28/Token/types"
            xmlns:ldb="http://thalesgroup.com/RTTI/2017-02-02/ldb/">
            <soap:Header>
              <typ:AccessToken>
                <typ:TokenValue>${TRAIN_TOKEN}</typ:TokenValue>
              </typ:AccessToken>
            </soap:Header>
            <soap:Body>
              <ldb:GetDepBoardWithDetailsRequest>
                <ldb:numRows>10</ldb:numRows>
                <ldb:crs>DEP</ldb:crs>
              </ldb:GetDepBoardWithDetailsRequest>
            </soap:Body>
          </soap:Envelope>
          XMLEOF

          curl -s -X POST \
            -H "Content-Type: text/xml;charset=UTF-8" \
            -H "SOAPAction: http://thalesgroup.com/RTTI/2017-02-02/ldb/GetDepBoardWithDetails" \
            --data @request.xml \
            https://lite.realtime.nationalrail.co.uk/OpenLDBWS/ldb11.asmx > raw.xml

          echo "=== RAW XML ==="
          cat raw.xml

      - name: Convert XML to JSON
        run: |
          python3 - <<'EOF'
          import xml.etree.ElementTree as ET, json
          from datetime import datetime, timezone

          with open('raw.xml', 'r', encoding='utf-8') as f:
            raw = f.read()

          root = ET.fromstring(raw)

          # Check for SOAP fault first
          faults = [e for e in root.iter() if e.tag.split('}')[-1] == 'Fault']
          if faults:
            fs = [e for e in root.iter() if e.tag.split('}')[-1] == 'faultstring']
            print("SOAP FAULT:", fs[0].text if fs else 'unknown')
            json.dump({'updated': datetime.now(timezone.utc).strftime('%H:%M'), 'trains': [], 'error': fs[0].text if fs else 'SOAP fault'}, open('trains.json','w'))
            exit(0)

          def find_all(el, local):
            return [e for e in el.iter() if e.tag.split('}')[-1] == local]

          def find_one(el, *tags):
            for tag in tags:
              r = find_all(el, tag)
              if r and r[0].text:
                return r[0].text.strip()
            return ''

          services = find_all(root, 'service')
          print(f"Found {len(services)} services")

          trains = []
          for svc in services:
            aimed = find_one(svc, 'std', 'sta')
            exp   = find_one(svc, 'etd', 'eta') or 'On time'
            dest  = find_one(svc, 'locationName')
            plat  = find_one(svc, 'platform')
            op    = find_one(svc, 'operator')
            cp_names = [
              e.text.strip()
              for cp in find_all(svc, 'callingPoint')
              for e in find_all(cp, 'locationName')
              if e.text
            ]
            trains.append({
              'aimed': aimed,
              'expected': exp,
              'destination': dest,
              'platform': plat,
              'operator': op,
              'callingPoints': cp_names,
              'cancelled': exp.lower() == 'cancelled'
            })
            print(f"  {aimed} -> {dest} ({exp})")

          out = {
            'updated': datetime.now(timezone.utc).strftime('%H:%M'),
            'trains': trains[:10]
          }

          with open('trains.json', 'w') as f:
            json.dump(out, f)

          print(f"Done â€” written {len(trains)} trains")
          EOF

      - name: Commit trains.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add trains.json
          git diff --cached --quiet || git commit -m "chore: update trains $(date -u +'%H:%M')"
          git push
