name: Fetch Trains

on:
  schedule:
    - cron: '* * * * *'   # every minute
  workflow_dispatch:        # allow manual trigger

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Deptford departures from Darwin
        env:
          TRAIN_TOKEN: ${{ secrets.TRAIN_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Content-Type: text/xml;charset=UTF-8" \
            -H "SOAPAction: http://thalesgroup.com/RTTI/2017-02-02/ldb/GetDepBoardWithDetails" \
            --data "<?xml version='1.0' encoding='utf-8'?>
          <soap:Envelope xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'
            xmlns:typ='http://thalesgroup.com/RTTI/2013-11-28/Token/types'
            xmlns:ldb='http://thalesgroup.com/RTTI/2017-02-02/ldb/'>
            <soap:Header>
              <typ:AccessToken><typ:TokenValue>${TRAIN_TOKEN}</typ:TokenValue></typ:AccessToken>
            </soap:Header>
            <soap:Body>
              <ldb:GetDepBoardWithDetailsRequest>
                <ldb:numRows>10</ldb:numRows>
                <ldb:crs>DEP</ldb:crs>
              </ldb:GetDepBoardWithDetailsRequest>
            </soap:Body>
          </soap:Envelope>" \
            https://lite.realtime.nationalrail.co.uk/OpenLDBWS/ldb11.asmx > raw.xml

      - name: Convert XML to JSON
        run: |
          python3 - <<'EOF'
          import xml.etree.ElementTree as ET, json
          from datetime import datetime

          with open('raw.xml', 'r', encoding='utf-8') as f:
            raw = f.read()

          # Print full XML so we can debug tag names
          print("=== FULL XML ===")
          print(raw)
          print("=== END XML ===")

          root = ET.fromstring(raw)

          # Print every unique tag in the document
          all_tags = sorted(set(e.tag.split('}')[-1] for e in root.iter()))
          print("ALL TAGS FOUND:", all_tags)

          def find_all_tag(el, local):
            return [e for e in el.iter() if e.tag.split('}')[-1] == local]

          def find_one(el, *locals):
            for local in locals:
              results = find_all_tag(el, local)
              if results and results[0].text:
                return results[0].text.strip()
            return ''

          # Try both 'service' and 'trainServices' as container
          services = find_all_tag(root, 'service')
          print(f"Found {len(services)} service elements")

          trains = []
          for svc in services:
            aimed = find_one(svc, 'std', 'sta')
            exp   = find_one(svc, 'etd', 'eta') or 'On time'
            dest  = find_one(svc, 'locationName')
            plat  = find_one(svc, 'platform')
            op    = find_one(svc, 'operator')

            # All locationName values inside callingPoint elements only
            cp_names = [
              e.text.strip()
              for cp in find_all_tag(svc, 'callingPoint')
              for e in find_all_tag(cp, 'locationName')
              if e.text
            ]

            trains.append({
              'aimed': aimed,
              'expected': exp,
              'destination': dest,
              'platform': plat,
              'operator': op,
              'callingPoints': cp_names,
              'cancelled': exp.lower() == 'cancelled'
            })

          out = {
            'updated': datetime.utcnow().strftime('%H:%M'),
            'trains': trains[:10]
          }

          with open('trains.json', 'w') as f:
            json.dump(out, f)

          print(f"Written {len(trains)} trains")
          if trains:
            print("First train:", json.dumps(trains[0], indent=2))
          EOF

      - name: Commit trains.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add trains.json
          git diff --cached --quiet || git commit -m "chore: update trains $(date -u +'%H:%M')"
          git push
