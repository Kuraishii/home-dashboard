<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --glass:rgba(255,255,255,0.09);
  --glass-b:rgba(255,255,255,0.16);
  --text:rgba(255,255,255,0.95);
  --dim:rgba(255,255,255,0.55);
  --accent:rgba(255,255,255,0.18);
  --radius:18px;
}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;color:var(--text);height:100vh;width:100vw;overflow:hidden;background:#0d1b2a}
#bg{position:fixed;inset:0;z-index:0;transition:background 4s ease}
#bg-overlay{position:fixed;inset:0;z-index:1;background:linear-gradient(160deg,rgba(0,0,0,0.15) 0%,rgba(0,0,0,0.45) 100%)}
#app{position:relative;z-index:2;height:100vh;width:100vw;display:grid;grid-template-columns:1fr 300px;grid-template-rows:auto 1fr;gap:10px;padding:14px}

.card{background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-b);border-radius:var(--radius);padding:14px;overflow:hidden}
.card-title{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);margin-bottom:10px}

/* TOP BAR */
#top{grid-column:1/-1;display:flex;align-items:center;gap:10px}
#weather-now{display:flex;align-items:center;gap:10px;min-width:190px}
#wi-big{font-size:48px;line-height:1}
#temp-now{font-size:34px;font-weight:300}
#w-desc{font-size:12px;color:var(--dim);text-transform:capitalize}
#w-meta{font-size:11px;color:var(--dim);margin-top:2px}
#clock-block{flex:1;text-align:center}
#clock{font-size:clamp(60px,8.5vw,96px);font-weight:200;letter-spacing:-2px;line-height:1;font-variant-numeric:tabular-nums}
#date-line{font-size:14px;color:var(--dim);margin-top:2px}
#sun-block{min-width:120px;text-align:right}
.sun-r{display:flex;align-items:center;justify-content:flex-end;gap:6px;font-size:13px;margin:3px 0}
#feels{font-size:11px;color:var(--dim);margin-top:6px;text-align:right}
#uv-inline{font-size:11px;color:var(--dim);margin-top:2px;text-align:right}

/* LEFT COLUMN */
#left{display:flex;flex-direction:column;gap:10px;overflow:hidden;min-height:0}
#hourly-scroll{display:flex;gap:7px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
#hourly-scroll::-webkit-scrollbar{display:none}
.hr{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:50px;background:var(--accent);border-radius:12px;padding:7px 5px;font-size:11px}
.hr-t{color:var(--dim);font-size:10px}
.hr-i{font-size:18px}
.hr-tmp{font-weight:500}
.hr-rain{font-size:9px;color:#7dd3fc}
.fc-r{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--glass-b);font-size:12px}
.fc-r:last-child{border:none}
.fc-day{width:70px;font-size:12px}
.fc-ico{font-size:17px;width:26px;text-align:center}
.fc-bw{flex:1;display:flex;align-items:center;gap:5px;margin:0 6px}
.fc-lo{color:var(--dim);font-size:11px;width:26px;text-align:right}
.fc-bg{flex:1;height:4px;border-radius:2px;background:rgba(255,255,255,0.12);position:relative}
.fc-fill{height:4px;border-radius:2px;background:linear-gradient(90deg,#7dd3fc,#fb923c);position:absolute}
.fc-hi{width:26px;font-size:11px}

/* SPOTIFY */
#sp-login-btn{width:100%;background:#1db954;border:none;color:white;border-radius:10px;padding:9px;font-size:13px;cursor:pointer;font-weight:600;letter-spacing:.3px}
#sp-player{display:none}
#sp-inner{display:flex;align-items:center;gap:10px}
#sp-art{width:54px;height:54px;border-radius:10px;background:var(--accent);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}
#sp-art img{width:100%;height:100%;object-fit:cover;border-radius:10px}
#sp-info{flex:1;overflow:hidden}
#sp-track{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#sp-artist{font-size:11px;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
#sp-prog{height:3px;background:rgba(255,255,255,0.15);border-radius:2px;margin-top:8px}
#sp-pfill{height:3px;background:#1db954;border-radius:2px;width:0%;transition:width 1s linear}
#sp-ctrl{display:flex;align-items:center;justify-content:center;gap:18px;margin-top:8px}
.sp-b{background:none;border:none;color:var(--text);cursor:pointer;font-size:19px;padding:3px;opacity:.75;transition:opacity .2s;line-height:1}
.sp-b:hover{opacity:1}
#sp-pp{font-size:26px}
#sp-idle{font-size:11px;color:var(--dim);margin-top:4px;text-align:center}

/* RIGHT COLUMN */
#right{display:flex;flex-direction:column;gap:10px;overflow:hidden;min-height:0}
#cal-card{flex:2;display:flex;flex-direction:column;min-height:0}
#cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
#cal-month{font-size:13px;font-weight:500}
.cal-nav{background:none;border:none;color:var(--text);font-size:16px;cursor:pointer;padding:2px 6px;opacity:0.7;transition:opacity .2s}
.cal-nav:hover{opacity:1}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;flex:1}
.cal-dow{font-size:9px;color:var(--dim);text-align:center;padding:2px 0}
.cal-day{display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:8px;font-size:10px;gap:1px;padding:2px 0}
.cal-day.today{background:rgba(255,255,255,0.22);font-weight:700}
.cal-day.other{color:var(--dim);opacity:0.35}
.cal-day.bh{color:#fbbf24}
.cal-day .cn{line-height:1}
.cal-day .cd{font-size:8px;line-height:1}
#moon-card{flex:0 0 auto}
#moon-inner{display:flex;align-items:center;gap:12px}
#moon-vis{font-size:46px;line-height:1}
#moon-name{font-size:15px;font-weight:500}
#moon-pct{font-size:11px;color:var(--dim);margin-top:2px}
#moon-next{font-size:11px;color:var(--dim);margin-top:3px}
#train-card{flex:0 0 auto}
#train-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
#train-upd{font-size:9px;color:var(--dim)}
.tr{display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--glass-b);font-size:12px}
.tr:last-child{border:none}
.tr-time{font-weight:700;font-size:14px;min-width:40px;font-variant-numeric:tabular-nums}
.tr-dest{flex:1;font-size:11px}
.tr-dest.cannon{font-weight:800;color:#fbbf24}
.tr-dest.bridge{color:#7dd3fc;font-weight:600}
.tr-plat{font-size:10px;color:var(--dim);min-width:24px;text-align:center}
.tr-status{font-size:10px;min-width:46px;text-align:right}
.on-time{color:#4ade80}
.delayed{color:#f87171}
.cancelled{color:#f87171;text-decoration:line-through}
</style>
</head>
<body>
<div id="bg"></div>
<div id="bg-overlay"></div>
<div id="app">

  <!-- TOP BAR -->
  <div id="top">
    <div id="weather-now" class="card">
      <div id="wi-big">â›…</div>
      <div>
        <div id="temp-now">--Â°</div>
        <div id="w-desc">Loadingâ€¦</div>
        <div id="w-meta"></div>
      </div>
    </div>
    <div id="clock-block">
      <div id="clock">00:00</div>
      <div id="date-line">â€”</div>
    </div>
    <div id="sun-block" class="card">
      <div class="sun-r"><span>ğŸŒ…</span><span id="sr">--:--</span></div>
      <div class="sun-r"><span>ğŸŒ‡</span><span id="ss">--:--</span></div>
      <div id="feels">Feels like --Â°</div>
      <div id="uv-inline">UV: --</div>
    </div>
  </div>

  <!-- LEFT COLUMN -->
  <div id="left">
    <div class="card" id="hourly-card">
      <div class="card-title">Hourly</div>
      <div id="hourly-scroll"><span style="color:var(--dim);font-size:12px">Loadingâ€¦</span></div>
    </div>
    <div class="card" id="forecast-card" style="flex:1">
      <div class="card-title">5-Day Forecast</div>
      <div id="fc-list"><span style="color:var(--dim);font-size:12px">Loadingâ€¦</span></div>
    </div>
    <div id="sp-card" class="card">
      <div class="card-title">Now Playing</div>
      <button id="sp-login-btn">Connect Spotify</button>
      <div id="sp-player">
        <div id="sp-inner">
          <div id="sp-art">â™ª</div>
          <div id="sp-info">
            <div id="sp-track">Nothing playing</div>
            <div id="sp-artist">â€”</div>
          </div>
        </div>
        <div id="sp-prog"><div id="sp-pfill"></div></div>
        <div id="sp-ctrl">
          <button class="sp-b" id="sp-prev">â®</button>
          <button class="sp-b" id="sp-pp">â–¶</button>
          <button class="sp-b" id="sp-next">â­</button>
        </div>
        <div id="sp-idle"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div id="right">
    <div id="cal-card" class="card">
      <div id="cal-head">
        <button class="cal-nav" id="cal-prev">â€¹</button>
        <div id="cal-month">â€”</div>
        <button class="cal-nav" id="cal-next">â€º</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>
    <div id="moon-card" class="card">
      <div class="card-title">Moon Phase</div>
      <div id="moon-inner">
        <div id="moon-vis">ğŸŒ•</div>
        <div>
          <div id="moon-name">â€”</div>
          <div id="moon-pct">Illumination: --%</div>
          <div id="moon-next">Next: â€”</div>
        </div>
      </div>
    </div>
    <div id="train-card" class="card">
      <div id="train-head">
        <div class="card-title" style="margin:0">Deptford â†’ London</div>
        <div id="train-upd"></div>
      </div>
      <div id="train-list"><span style="color:var(--dim);font-size:12px">Loadingâ€¦</span></div>
    </div>
  </div>

</div><!-- end #app -->

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LAT = 51.4779, LON = -0.0015;
const TRAIN_TOKEN = 'a6d2c92a-e73b-4f27-8edc-53a8bca090d9';
const SP_CLIENT_ID = 'a61a2fffda4f42bb8805650ff52bf415';
const REDIRECT_URI = 'https://kuraishii.github.io/home-dashboard/';
const SP_SCOPES = 'user-read-playback-state user-modify-playback-state user-read-currently-playing';

const DAYS   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const SDAYS  = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

const BH = new Set([
  '2025-01-01','2025-04-18','2025-04-21','2025-05-05','2025-05-26','2025-08-25','2025-12-25','2025-12-26',
  '2026-01-01','2026-04-03','2026-04-06','2026-05-04','2026-05-25','2026-08-31','2026-12-25','2026-12-28'
]);
function isBH(d){ const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; return BH.has(k); }

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick(){
  const n=new Date();
  document.getElementById('clock').textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
  document.getElementById('date-line').textContent=`${DAYS[n.getDay()]}, ${n.getDate()} ${MONTHS[n.getMonth()]} ${n.getFullYear()}`;
}
setInterval(tick,1000); tick();

// â”€â”€ BACKGROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _wid=800, _sr=null, _ss=null;
const BG={
  clear_day:'linear-gradient(135deg,#1565c0 0%,#42a5f5 55%,#ffcc02 100%)',
  clear_dawn:'linear-gradient(135deg,#e91e63 0%,#ff9800 45%,#1565c0 100%)',
  clear_dusk:'linear-gradient(135deg,#bf360c 0%,#e65100 40%,#1a237e 100%)',
  clear_night:'linear-gradient(135deg,#0d0d1a 0%,#1a1a3e 55%,#283593 100%)',
  cloud_day:'linear-gradient(135deg,#455a64 0%,#78909c 55%,#b0bec5 100%)',
  cloud_night:'linear-gradient(135deg,#1c2331 0%,#2d3a4a 55%,#455a64 100%)',
  rain_day:'linear-gradient(135deg,#263238 0%,#37474f 40%,#546e7a 100%)',
  rain_night:'linear-gradient(135deg,#0a0e14 0%,#162029 55%,#263238 100%)',
  snow:'linear-gradient(135deg,#cfd8dc 0%,#b0bec5 50%,#90a4ae 100%)',
  thunder:'linear-gradient(135deg,#12001f 0%,#1a0030 55%,#0d1b2a 100%)',
};
function pickBg(id,now,sr,ss){
  const h=now.getHours(), srH=sr?new Date(sr*1000).getHours():6, ssH=ss?new Date(ss*1000).getHours():20;
  const isDay=h>=srH&&h<ssH, isDawn=h>=srH-1&&h<srH+1, isDusk=h>=ssH-1&&h<ssH+1;
  if(id>=200&&id<300) return BG.thunder;
  if(id>=300&&id<600) return isDay?BG.rain_day:BG.rain_night;
  if(id>=600&&id<700) return BG.snow;
  if(id>=801) return isDay?BG.cloud_day:BG.cloud_night;
  if(isDawn) return BG.clear_dawn;
  if(isDusk) return BG.clear_dusk;
  return isDay?BG.clear_day:BG.clear_night;
}
function updateBg(){ document.getElementById('bg').style.background=pickBg(_wid,new Date(),_sr,_ss); }
setInterval(updateBg,60000); updateBg();

// â”€â”€ WEATHER HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wmoIcon(code,isDay=true){
  if(code===0) return isDay?'â˜€ï¸':'ğŸŒ™';
  if(code<=2) return isDay?'ğŸŒ¤ï¸':'ğŸŒ™';
  if(code===3) return 'â˜ï¸';
  if(code<=49) return 'ğŸŒ«ï¸';
  if(code<=59) return 'ğŸŒ¦ï¸';
  if(code<=69) return 'ğŸŒ§ï¸';
  if(code<=79) return 'â„ï¸';
  if(code<=84) return 'ğŸŒ§ï¸';
  if(code<=94) return 'ğŸŒ¨ï¸';
  return 'â›ˆï¸';
}
function wmoDesc(code){
  const m={0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Foggy',48:'Icy fog',51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',61:'Light rain',63:'Rain',65:'Heavy rain',71:'Light snow',73:'Snow',75:'Heavy snow',77:'Snow grains',80:'Showers',81:'Rain showers',82:'Violent showers',85:'Snow showers',86:'Heavy snow showers',95:'Thunderstorm',96:'Thunderstorm w/ hail',99:'Severe thunderstorm'};
  return m[code]||'Unknown';
}
function wmoToId(code){
  if(code===0) return 800; if(code<=2) return 801; if(code===3) return 804;
  if(code<=49) return 741; if(code<=59) return 300; if(code<=69) return 501;
  if(code<=79) return 601; if(code<=84) return 502; if(code<=94) return 621;
  return 211;
}

// â”€â”€ OPEN-METEO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWeather(){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}`+
      `&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,is_day`+
      `&hourly=temperature_2m,weather_code,precipitation_probability`+
      `&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max`+
      `&timezone=Europe%2FLondon&forecast_days=6`;
    const d=await fetch(url).then(r=>r.json());
    const c=d.current, daily=d.daily, hourly=d.hourly;
    const isDay=c.is_day===1;
    _wid=wmoToId(c.weather_code);
    const srStr=daily.sunrise[0], ssStr=daily.sunset[0];
    _sr=new Date(srStr).getTime()/1000;
    _ss=new Date(ssStr).getTime()/1000;
    updateBg();
    document.getElementById('wi-big').textContent=wmoIcon(c.weather_code,isDay);
    document.getElementById('temp-now').textContent=`${Math.round(c.temperature_2m)}Â°`;
    document.getElementById('w-desc').textContent=wmoDesc(c.weather_code);
    document.getElementById('w-meta').textContent=`Humidity ${c.relative_humidity_2m}% Â· Wind ${Math.round(c.wind_speed_10m)} km/h`;
    document.getElementById('feels').textContent=`Feels like ${Math.round(c.apparent_temperature)}Â°`;
    const uv=daily.uv_index_max[0];
    const uvLbl=uv<=2?'Low':uv<=5?'Moderate':uv<=7?'High':uv<=10?'Very High':'Extreme';
    document.getElementById('uv-inline').textContent=`UV ${uv} â€” ${uvLbl}`;
    document.getElementById('sr').textContent=new Date(srStr).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    document.getElementById('ss').textContent=new Date(ssStr).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    // Hourly
    const nowIdx=Math.max(0,hourly.time.findIndex(t=>new Date(t)>new Date())-1);
    document.getElementById('hourly-scroll').innerHTML=hourly.time.slice(nowIdx,nowIdx+13).map((t,i)=>{
      const idx=nowIdx+i, hDate=new Date(t), hIsDay=hDate.getHours()>=6&&hDate.getHours()<21;
      const rain=hourly.precipitation_probability[idx]||0;
      return `<div class="hr"><div class="hr-t">${String(hDate.getHours()).padStart(2,'0')}:00</div><div class="hr-i">${wmoIcon(hourly.weather_code[idx],hIsDay)}</div><div class="hr-tmp">${Math.round(hourly.temperature_2m[idx])}Â°</div><div class="hr-rain">${rain>0?rain+'%ğŸ’§':'â€”'}</div></div>`;
    }).join('');
    // 5-day
    const loT=Math.min(...daily.temperature_2m_min), hiT=Math.max(...daily.temperature_2m_max), rng=hiT-loT||1;
    document.getElementById('fc-list').innerHTML=daily.weather_code.slice(0,5).map((code,i)=>{
      const date=new Date(daily.sunrise[i]), dayName=i===0?'Today':SDAYS[date.getDay()];
      const lo=Math.round(daily.temperature_2m_min[i]), hi=Math.round(daily.temperature_2m_max[i]);
      const left=((lo-loT)/rng*75).toFixed(1), w=(((hi-lo)/rng*75)||4).toFixed(1);
      return `<div class="fc-r"><div class="fc-day">${dayName}</div><div class="fc-ico">${wmoIcon(code,true)}</div><div class="fc-bw"><div class="fc-lo">${lo}Â°</div><div class="fc-bg"><div class="fc-fill" style="left:${left}%;width:${w}%"></div></div><div class="fc-hi">${hi}Â°</div></div></div>`;
    }).join('');
  }catch(e){console.error('Weather',e)}
}
fetchWeather(); setInterval(fetchWeather,10*60*1000);

// â”€â”€ MOON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function moonPhase(date=new Date()){
  const LUNAR=29.53058867;
  const known=new Date('2000-01-06T18:14:00Z');
  const age=((((date-known)/(864e5))%LUNAR)+LUNAR)%LUNAR;
  const pct=Math.round((Math.cos((age/LUNAR)*2*Math.PI)*-0.5+0.5)*100);
  const phases=[
    {n:'New Moon',e:'ğŸŒ‘',max:1.85},{n:'Waxing Crescent',e:'ğŸŒ’',max:7.38},
    {n:'First Quarter',e:'ğŸŒ“',max:11.08},{n:'Waxing Gibbous',e:'ğŸŒ”',max:14.77},
    {n:'Full Moon',e:'ğŸŒ•',max:16.61},{n:'Waning Gibbous',e:'ğŸŒ–',max:22.15},
    {n:'Last Quarter',e:'ğŸŒ—',max:25.84},{n:'Waning Crescent',e:'ğŸŒ˜',max:29.53},
  ];
  const ph=phases.find(p=>age<=p.max)||phases[0];
  const nextKeys=[0,7.38,14.77,22.15];
  const nextNames=['New Moon','First Quarter','Full Moon','Last Quarter'];
  const nextAge=nextKeys.find(a=>a>age)??(LUNAR+nextKeys[0]);
  const daysLeft=Math.round(nextAge>age?nextAge-age:LUNAR-age+nextKeys[0]);
  const nextName=nextNames[nextKeys.indexOf(nextAge)]??'New Moon';
  return {name:ph.n,emoji:ph.e,pct,age:Math.round(age),daysLeft,nextName};
}
function renderMoon(){
  const m=moonPhase();
  document.getElementById('moon-vis').textContent=m.emoji;
  document.getElementById('moon-name').textContent=m.name;
  document.getElementById('moon-pct').textContent=`Illumination ${m.pct}% Â· Day ${m.age}`;
  document.getElementById('moon-next').textContent=`Next: ${m.nextName} in ${m.daysLeft}d`;
}
renderMoon(); setInterval(renderMoon,3600000);

// â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let calYear=new Date().getFullYear(), calMonth=new Date().getMonth();
function moonEventsInMonth(y,m){
  const LUNAR=29.53058867, known=new Date('2000-01-06T18:14:00Z');
  const days=new Date(y,m+1,0).getDate(), events={};
  for(let d=1;d<=days;d++){
    const cur=new Date(y,m,d,12,0,0), prev=new Date(y,m,d-1,12,0,0);
    const age=((((cur-known)/(864e5))%LUNAR)+LUNAR)%LUNAR;
    const pAge=((((prev-known)/(864e5))%LUNAR)+LUNAR)%LUNAR;
    if((pAge>27&&age<2)||(pAge>age&&age<1)) events[d]='ğŸŒ‘';
    if(pAge<14.77&&age>=14.77&&age<16) events[d]='ğŸŒ•';
  }
  return events;
}
function renderCal(){
  const today=new Date();
  document.getElementById('cal-month').textContent=`${MONTHS[calMonth]} ${calYear}`;
  const moonEv=moonEventsInMonth(calYear,calMonth);
  const firstDow=(new Date(calYear,calMonth,1).getDay()+6)%7;
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const prevDays=new Date(calYear,calMonth,0).getDate();
  let html=['M','T','W','T','F','S','S'].map(d=>`<div class="cal-dow">${d}</div>`).join('');
  for(let i=firstDow-1;i>=0;i--) html+=`<div class="cal-day other"><div class="cn">${prevDays-i}</div></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(calYear,calMonth,d);
    const isToday=d===today.getDate()&&calMonth===today.getMonth()&&calYear===today.getFullYear();
    const cls=['cal-day',isToday?'today':'',isBH(date)?'bh':''].filter(Boolean).join(' ');
    html+=`<div class="${cls}"><div class="cn">${d}</div>${moonEv[d]?`<div class="cd">${moonEv[d]}</div>`:''}</div>`;
  }
  document.getElementById('cal-grid').innerHTML=html;
}
renderCal();
document.getElementById('cal-prev').onclick=()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}renderCal()};
document.getElementById('cal-next').onclick=()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}renderCal()};

// â”€â”€ TRAINS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SOAP_EP='https://lite.realtime.nationalrail.co.uk/OpenLDBWS/ldb11.asmx';
const PROXY='https://corsproxy.io/?url=';
async function fetchTrains(){
  const soap=`<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:typ="http://thalesgroup.com/RTTI/2013-11-28/Token/types" xmlns:ldb="http://thalesgroup.com/RTTI/2017-02-02/ldb/"><soap:Header><typ:AccessToken><typ:TokenValue>${TRAIN_TOKEN}</typ:TokenValue></typ:AccessToken></soap:Header><soap:Body><ldb:GetDepBoardWithDetailsRequest><ldb:numRows>8</ldb:numRows><ldb:crs>DEP</ldb:crs></ldb:GetDepBoardWithDetailsRequest></soap:Body></soap:Envelope>`;
  try{
    const res=await fetch(PROXY+encodeURIComponent(SOAP_EP),{method:'POST',headers:{'Content-Type':'text/xml;charset=UTF-8','SOAPAction':'http://thalesgroup.com/RTTI/2017-02-02/ldb/GetDepBoardWithDetails'},body:soap});
    const doc=new DOMParser().parseFromString(await res.text(),'text/xml');
    const svcs=doc.querySelectorAll('trainServices service');
    if(!svcs.length){document.getElementById('train-list').innerHTML='<span style="color:var(--dim);font-size:11px">No departures</span>';return;}
    document.getElementById('train-list').innerHTML=[...svcs].slice(0,6).map(svc=>{
      const g=tag=>svc.getElementsByTagNameNS('*',tag)[0]?.textContent.trim()||'';
      const aimed=g('std')||'--:--', exp=g('etd')||'On time', dest=g('locationName'), plat=g('platform');
      const cps=[...svc.querySelectorAll('callingPointList callingPoint')].map(cp=>cp.getElementsByTagNameNS('*','locationName')[0]?.textContent||'');
      const isCannon=dest.includes('Cannon')||cps.some(n=>n.includes('Cannon'));
      const isBridge=dest.includes('London Bridge')||cps.some(n=>n.includes('London Bridge'));
      const cancelled=exp.toLowerCase()==='cancelled';
      const statusCls=cancelled?'cancelled':exp!=='On time'&&exp!=='No report'&&exp!==aimed?'delayed':'on-time';
      const destCls=isCannon?'cannon':isBridge?'bridge':'';
      const prefix=isCannon?'â˜… ':isBridge?'â—† ':'';
      return `<div class="tr"><div class="tr-time">${aimed}</div><div class="tr-dest ${destCls}">${prefix}${dest}</div><div class="tr-plat">${plat?'P'+plat:''}</div><div class="tr-status ${statusCls}">${cancelled?'Cancelled':exp}</div></div>`;
    }).join('');
    document.getElementById('train-upd').textContent=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
  }catch(e){document.getElementById('train-list').innerHTML='<span style="color:var(--dim);font-size:11px">âš  Could not load trains</span>';}
}
fetchTrains(); setInterval(fetchTrains,60000);

// â”€â”€ SPOTIFY PKCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function b64url(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'')}
async function pkceChallenge(){
  const verifier=b64url(crypto.getRandomValues(new Uint8Array(32)));
  const hash=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(verifier));
  return{verifier,challenge:b64url(hash)};
}
async function spLogin(){
  const{verifier,challenge}=await pkceChallenge();
  sessionStorage.setItem('sp_verifier',verifier);
  const p=new URLSearchParams({client_id:SP_CLIENT_ID,response_type:'code',redirect_uri:REDIRECT_URI,scope:SP_SCOPES,code_challenge_method:'S256',code_challenge:challenge});
  location.href=`https://accounts.spotify.com/authorize?${p}`;
}
async function exchangeCode(code){
  const res=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:REDIRECT_URI,client_id:SP_CLIENT_ID,code_verifier:sessionStorage.getItem('sp_verifier')})});
  const data=await res.json();
  if(data.access_token){
    localStorage.setItem('sp_access',data.access_token);
    localStorage.setItem('sp_refresh',data.refresh_token);
    localStorage.setItem('sp_exp',Date.now()+data.expires_in*1000);
    history.replaceState({},'',REDIRECT_URI);
    initSpotify();
  }
}
async function refreshToken(){
  const rt=localStorage.getItem('sp_refresh'); if(!rt) return false;
  const res=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({grant_type:'refresh_token',refresh_token:rt,client_id:SP_CLIENT_ID})});
  const data=await res.json();
  if(data.access_token){localStorage.setItem('sp_access',data.access_token);localStorage.setItem('sp_exp',Date.now()+data.expires_in*1000);if(data.refresh_token)localStorage.setItem('sp_refresh',data.refresh_token);return true;}
  return false;
}
async function spToken(){
  if(Date.now()>Number(localStorage.getItem('sp_exp'))-30000){if(!await refreshToken()){localStorage.removeItem('sp_access');return null;}}
  return localStorage.getItem('sp_access');
}
async function spFetch(url,opts={}){
  const tok=await spToken(); if(!tok) return null;
  return fetch(url,{...opts,headers:{...opts.headers,'Authorization':`Bearer ${tok}`}});
}

let spPoll=null;
function initSpotify(){
  document.getElementById('sp-login-btn').style.display='none';
  document.getElementById('sp-player').style.display='block';
  pollSp();
  spPoll=setInterval(pollSp,3000);
}
async function pollSp(){
  const res=await spFetch('https://api.spotify.com/v1/me/player/currently-playing');
  if(!res||res.status===401){localStorage.removeItem('sp_access');document.getElementById('sp-login-btn').style.display='block';document.getElementById('sp-player').style.display='none';clearInterval(spPoll);return;}
  if(res.status===204){document.getElementById('sp-track').textContent='Nothing playing';document.getElementById('sp-artist').textContent='';document.getElementById('sp-idle').textContent='Open Spotify to start playing';return;}
  const data=await res.json();
  if(!data||!data.item) return;
  const tr=data.item;
  document.getElementById('sp-track').textContent=tr.name;
  document.getElementById('sp-artist').textContent=tr.artists.map(a=>a.name).join(', ');
  document.getElementById('sp-idle').textContent='';
  const img=tr.album?.images?.[0]?.url;
  document.getElementById('sp-art').innerHTML=img?`<img src="${img}" alt="">`:'â™ª';
  document.getElementById('sp-pfill').style.width=`${(data.progress_ms/tr.duration_ms*100).toFixed(1)}%`;
  document.getElementById('sp-pp').textContent=data.is_playing?'â¸':'â–¶';
}
async function spCmd(ep,method='PUT'){
  const tok=await spToken(); if(!tok) return;
  await fetch(`https://api.spotify.com/v1/me/player/${ep}`,{method,headers:{'Authorization':`Bearer ${tok}`}});
  setTimeout(pollSp,400);
}

// Wire up buttons after DOM is ready
document.getElementById('sp-login-btn').addEventListener('click', spLogin);
document.getElementById('sp-prev').addEventListener('click', ()=>spCmd('previous','POST'));
document.getElementById('sp-next').addEventListener('click', ()=>spCmd('next','POST'));
document.getElementById('sp-pp').addEventListener('click', async()=>{
  const res=await spFetch('https://api.spotify.com/v1/me/player');
  if(!res) return;
  const st=await res.json();
  spCmd(st.is_playing?'pause':'play');
});

// Handle OAuth callback or restore session
const urlParams=new URLSearchParams(location.search);
const authCode=urlParams.get('code');
if(authCode) exchangeCode(authCode);
else if(localStorage.getItem('sp_access')) initSpotify();
</script>
</body>
</html>
