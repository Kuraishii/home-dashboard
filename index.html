<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --glass:rgba(255,255,255,0.09);
  --glass-b:rgba(255,255,255,0.16);
  --text:rgba(255,255,255,0.95);
  --dim:rgba(255,255,255,0.55);
  --accent:rgba(255,255,255,0.18);
  --radius:18px;
}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;color:var(--text);height:100vh;width:100vw;overflow:hidden;background:#0d1b2a}
#bg{position:fixed;inset:0;z-index:0;transition:background 4s ease}
#bg-overlay{position:fixed;inset:0;z-index:1;background:linear-gradient(160deg,rgba(0,0,0,0.15) 0%,rgba(0,0,0,0.45) 100%)}
#app{position:relative;z-index:2;height:100vh;width:100vw;display:grid;grid-template-columns:1fr 300px;grid-template-rows:auto 1fr;gap:10px;padding:14px}

.card{background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-b);border-radius:var(--radius);padding:14px;overflow:hidden}
.card-title{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);margin-bottom:10px}

/* TOP */
#top{grid-column:1/-1;display:flex;align-items:center;gap:10px}
#weather-now{display:flex;align-items:center;gap:10px;min-width:190px}
#wi-big{font-size:48px;line-height:1}
#temp-now{font-size:34px;font-weight:300}
#w-desc{font-size:12px;color:var(--dim);text-transform:capitalize}
#w-meta{font-size:11px;color:var(--dim);margin-top:2px}
#clock-block{flex:1;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center}
#clock{font-size:clamp(60px,8.5vw,96px);font-weight:200;letter-spacing:-2px;line-height:1;font-variant-numeric:tabular-nums}
#date-line{font-size:14px;color:var(--dim);margin-top:2px}
#sun-block{min-width:120px;text-align:right}
.sun-r{display:flex;align-items:center;justify-content:flex-end;gap:6px;font-size:13px;margin:3px 0}
#feels{font-size:11px;color:var(--dim);margin-top:6px;text-align:right}
#uv-inline{font-size:11px;color:var(--dim);margin-top:2px;text-align:right}

/* LEFT ‚Äî spotify gets flex:0, forecast fills remaining */
#left{display:flex;flex-direction:column;gap:10px;overflow:hidden;min-height:0}
#hourly-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px}
.hr{display:flex;flex-direction:column;align-items:center;gap:3px;background:var(--accent);border-radius:12px;padding:7px 4px;font-size:11px;min-width:0}
.hr-t{color:var(--dim);font-size:10px}
.hr-i{font-size:17px}
.hr-tmp{font-weight:500}
.hr-rain{font-size:9px;color:#7dd3fc}

/* forecast fills remaining height, rows evenly spaced */
#forecast-card{flex:1;display:flex;flex-direction:column;min-height:0}
#fc-list{flex:1;display:flex;flex-direction:column;justify-content:space-between;min-height:0}
.fc-r{display:flex;align-items:center;flex:1;border-bottom:1px solid var(--glass-b)}
.fc-r:last-child{border:none}
.fc-day{width:60px;font-size:11px}
.fc-ico{font-size:16px;width:24px;text-align:center}
.fc-bw{flex:1;display:flex;align-items:center;gap:4px;margin:0 5px}
.fc-lo{color:var(--dim);font-size:11px;width:26px;text-align:right}
.fc-bg{flex:1;height:4px;border-radius:2px;background:rgba(255,255,255,0.12);position:relative}
.fc-fill{height:4px;border-radius:2px;background:linear-gradient(90deg,#7dd3fc,#fb923c);position:absolute}
.fc-hi{width:26px;font-size:11px}

/* Spotify ‚Äî fixed height, bigger */
#sp-card{flex:0 0 auto}
.sw{display:flex;align-items:center;gap:10px}
.sc{width:80px;height:80px;border-radius:12px;background:var(--accent);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:32px;overflow:hidden}
.sc img{width:100%;height:100%;object-fit:cover;border-radius:12px}
.sph{font-size:32px}
.sif{flex:1;overflow:hidden}
.str{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sar{font-size:12px;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:3px}
.scr{display:flex;align-items:center;gap:20px;margin-top:10px}
.sb{background:none;border:none;color:var(--text);cursor:pointer;font-size:22px;padding:2px;opacity:.75;transition:opacity .2s;line-height:1}
.sb:hover{opacity:1}
.pp{font-size:32px}
.spr{height:3px;background:rgba(255,255,255,0.15);border-radius:2px;margin-top:10px}
.spf{height:3px;background:#1db954;border-radius:2px;transition:width .5s linear}
.sli{display:inline-block;margin-top:8px;background:#1db954;border:none;color:white;border-radius:8px;padding:6px 14px;font-size:12px;cursor:pointer;font-weight:600}

/* RIGHT ‚Äî trains gets more space, calendar less */
#right{display:flex;flex-direction:column;gap:10px;overflow:hidden;min-height:0}
#cal-card{flex:1;display:flex;flex-direction:column;min-height:0}
#cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
#cal-month{font-size:13px;font-weight:500}
.cal-nav{background:none;border:none;color:var(--text);font-size:16px;cursor:pointer;padding:2px 6px;opacity:.7;transition:opacity .2s}
.cal-nav:hover{opacity:1}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;flex:1}
.cal-dow{font-size:9px;color:var(--dim);text-align:center;padding:1px 0}
.cal-day{display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:6px;font-size:10px;gap:0px;padding:1px 0}
.cal-day.today{background:rgba(255,255,255,0.22);font-weight:700}
.cal-day.other{color:var(--dim);opacity:.35}
.cal-day.bh{color:#fbbf24}
.cn{line-height:1}
.cd{font-size:7px;line-height:1}
#moon-card{flex:0 0 auto}
#moon-inner{display:flex;align-items:center;gap:12px}
#moon-vis{font-size:42px;line-height:1}
#moon-name{font-size:14px;font-weight:500}
#moon-pct{font-size:11px;color:var(--dim);margin-top:2px}
#moon-next{font-size:11px;color:var(--dim);margin-top:2px}

/* Trains ‚Äî bigger, flex:1.8 */
#train-card{flex:1.8;display:flex;flex-direction:column;min-height:0}
#train-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-shrink:0}
#train-upd{font-size:9px;color:var(--dim)}
#train-list{flex:1;display:flex;flex-direction:column;justify-content:space-between;min-height:0}
.tr{display:flex;align-items:center;gap:6px;flex:1;border-bottom:1px solid var(--glass-b)}
.tr:last-child{border:none}
.tr-time{font-weight:700;font-size:15px;min-width:42px;font-variant-numeric:tabular-nums}
.tr-dest{flex:1;font-size:12px}
.tr-dest.cannon{font-weight:800;color:#fbbf24}
.tr-dest.bridge{color:#7dd3fc;font-weight:600}
.tr-plat{font-size:10px;color:var(--dim);min-width:24px;text-align:center}
.tr-status{font-size:11px;min-width:50px;text-align:right}
.on-time{color:#4ade80}
.delayed{color:#f87171}
.cancelled{color:#f87171;text-decoration:line-through}
</style>
</head>
<body>
<div id="bg"></div>
<div id="bg-overlay"></div>
<div id="app">

  <!-- TOP -->
  <div id="top">
    <div id="weather-now" class="card">
      <div id="wi-big">‚õÖ</div>
      <div>
        <div id="temp-now">--¬∞</div>
        <div id="w-desc">Loading‚Ä¶</div>
        <div id="w-meta"></div>
      </div>
    </div>
    <div id="clock-block">
      <div id="clock">00:00</div>
      <div id="date-line">‚Äî</div>
    </div>
    <div id="sun-block" class="card">
      <div class="sun-r"><span>üåÖ</span><span id="sr">--:--</span></div>
      <div class="sun-r"><span>üåá</span><span id="ss">--:--</span></div>
      <div id="feels">Feels like --¬∞</div>
      <div id="uv-inline">UV: --</div>
    </div>
  </div>

  <!-- LEFT -->
  <div id="left">
    <div class="card" id="hourly-card">
      <div class="card-title">Hourly</div>
      <div id="hourly-grid"><span style="color:var(--dim);font-size:12px">Loading‚Ä¶</span></div>
    </div>
    <div class="card" id="forecast-card">
      <div class="card-title">7-Day Forecast</div>
      <div id="fc-list"><span style="color:var(--dim);font-size:12px">Loading‚Ä¶</span></div>
    </div>
    <div id="sp-card" class="card">
      <div class="card-title">Now Playing</div>
      <div id="spB"></div>
    </div>
  </div>

  <!-- RIGHT -->
  <div id="right">
    <div id="cal-card" class="card">
      <div id="cal-head">
        <button class="cal-nav" id="cal-prev">‚Äπ</button>
        <div id="cal-month">‚Äî</div>
        <button class="cal-nav" id="cal-next">‚Ä∫</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>
    <div id="moon-card" class="card">
      <div class="card-title">Moon Phase</div>
      <div id="moon-inner">
        <div id="moon-vis">üåï</div>
        <div>
          <div id="moon-name">‚Äî</div>
          <div id="moon-pct">Illumination: --%</div>
          <div id="moon-next">Next: ‚Äî</div>
        </div>
      </div>
    </div>
    <div id="train-card" class="card">
      <div id="train-head">
        <div class="card-title" style="margin:0">Deptford ‚Üí London</div>
        <div id="train-upd"></div>
      </div>
      <div id="train-list"><span style="color:var(--dim);font-size:12px">Loading‚Ä¶</span></div>
    </div>
  </div>

</div>

<script>
const C={
  lat:51.4779,lon:-0.0015,
  trainToken:'a6d2c92a-e73b-4f27-8edc-53a8bca090d9',
  spId:'a61a2fffda4f42bb8805650ff52bf415',
  spRedirect:'https://kuraishii.github.io/home-dashboard/',
  spScopes:'user-read-playback-state user-modify-playback-state streaming user-read-currently-playing'
};
const DAYS=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const SDAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const BH=new Set(['2025-01-01','2025-04-18','2025-04-21','2025-05-05','2025-05-26','2025-08-25','2025-12-25','2025-12-26','2026-01-01','2026-04-03','2026-04-06','2026-05-04','2026-05-25','2026-08-31','2026-12-25','2026-12-28']);
function isBH(d){return BH.has(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`)}

// CLOCK
function tick(){
  const n=new Date();
  document.getElementById('clock').textContent=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;
  document.getElementById('date-line').textContent=`${DAYS[n.getDay()]}, ${n.getDate()} ${MONTHS[n.getMonth()]} ${n.getFullYear()}`;
}
setInterval(tick,1000);tick();

// BACKGROUND
let _wid=800,_sr=null,_ss=null;
const BG={clear_day:'linear-gradient(135deg,#1565c0 0%,#42a5f5 55%,#ffcc02 100%)',clear_dawn:'linear-gradient(135deg,#e91e63 0%,#ff9800 45%,#1565c0 100%)',clear_dusk:'linear-gradient(135deg,#bf360c 0%,#e65100 40%,#1a237e 100%)',clear_night:'linear-gradient(135deg,#0d0d1a 0%,#1a1a3e 55%,#283593 100%)',cloud_day:'linear-gradient(135deg,#455a64 0%,#78909c 55%,#b0bec5 100%)',cloud_night:'linear-gradient(135deg,#1c2331 0%,#2d3a4a 55%,#455a64 100%)',rain_day:'linear-gradient(135deg,#263238 0%,#37474f 40%,#546e7a 100%)',rain_night:'linear-gradient(135deg,#0a0e14 0%,#162029 55%,#263238 100%)',snow:'linear-gradient(135deg,#cfd8dc 0%,#b0bec5 50%,#90a4ae 100%)',thunder:'linear-gradient(135deg,#12001f 0%,#1a0030 55%,#0d1b2a 100%)'};
function pickBg(id,now,sr,ss){
  const h=now.getHours(),srH=sr?new Date(sr*1000).getHours():6,ssH=ss?new Date(ss*1000).getHours():20;
  const isDay=h>=srH&&h<ssH,isDawn=h>=srH-1&&h<srH+1,isDusk=h>=ssH-1&&h<ssH+1;
  if(id>=200&&id<300)return BG.thunder;
  if(id>=300&&id<600)return isDay?BG.rain_day:BG.rain_night;
  if(id>=600&&id<700)return BG.snow;
  if(id>=801)return isDay?BG.cloud_day:BG.cloud_night;
  if(isDawn)return BG.clear_dawn;if(isDusk)return BG.clear_dusk;
  return isDay?BG.clear_day:BG.clear_night;
}
function updateBg(){document.getElementById('bg').style.background=pickBg(_wid,new Date(),_sr,_ss);}
setInterval(updateBg,60000);updateBg();

// WEATHER HELPERS
function wmoIcon(c,d=true){if(c===0)return d?'‚òÄÔ∏è':'üåô';if(c<=2)return d?'üå§Ô∏è':'üåô';if(c===3)return'‚òÅÔ∏è';if(c<=49)return'üå´Ô∏è';if(c<=59)return'üå¶Ô∏è';if(c<=69)return'üåßÔ∏è';if(c<=79)return'‚ùÑÔ∏è';if(c<=84)return'üåßÔ∏è';if(c<=94)return'üå®Ô∏è';return'‚õàÔ∏è';}
function wmoDesc(c){const m={0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Foggy',48:'Icy fog',51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',61:'Light rain',63:'Rain',65:'Heavy rain',71:'Light snow',73:'Snow',75:'Heavy snow',77:'Snow grains',80:'Showers',81:'Rain showers',82:'Violent showers',85:'Snow showers',86:'Heavy snow showers',95:'Thunderstorm',96:'Thunderstorm w/ hail',99:'Severe thunderstorm'};return m[c]||'Unknown';}
function wmoToId(c){if(c===0)return 800;if(c<=2)return 801;if(c===3)return 804;if(c<=49)return 741;if(c<=59)return 300;if(c<=69)return 501;if(c<=79)return 601;if(c<=84)return 502;if(c<=94)return 621;return 211;}

// OPEN-METEO
async function fetchWeather(){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${C.lat}&longitude=${C.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,is_day&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max&timezone=Europe%2FLondon&forecast_days=8`;
    const d=await fetch(url).then(r=>r.json());
    const c=d.current,daily=d.daily,hourly=d.hourly,isDay=c.is_day===1;
    _wid=wmoToId(c.weather_code);
    _sr=new Date(daily.sunrise[0]).getTime()/1000;
    _ss=new Date(daily.sunset[0]).getTime()/1000;
    updateBg();
    document.getElementById('wi-big').textContent=wmoIcon(c.weather_code,isDay);
    document.getElementById('temp-now').textContent=`${Math.round(c.temperature_2m)}¬∞`;
    document.getElementById('w-desc').textContent=wmoDesc(c.weather_code);
    document.getElementById('w-meta').textContent=`Humidity ${c.relative_humidity_2m}% ¬∑ Wind ${Math.round(c.wind_speed_10m)} km/h`;
    document.getElementById('feels').textContent=`Feels like ${Math.round(c.apparent_temperature)}¬∞`;
    const uv=daily.uv_index_max[0];
    document.getElementById('uv-inline').textContent=`UV ${uv} ‚Äî ${uv<=2?'Low':uv<=5?'Moderate':uv<=7?'High':uv<=10?'Very High':'Extreme'}`;
    document.getElementById('sr').textContent=new Date(daily.sunrise[0]).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    document.getElementById('ss').textContent=new Date(daily.sunset[0]).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    // Hourly ‚Äî 8 tiles
    const ni=Math.max(0,hourly.time.findIndex(t=>new Date(t)>new Date())-1);
    document.getElementById('hourly-grid').innerHTML=hourly.time.slice(ni,ni+8).map((t,i)=>{
      const idx=ni+i,hd=new Date(t),hDay=hd.getHours()>=6&&hd.getHours()<21,rain=hourly.precipitation_probability[idx]||0;
      return `<div class="hr"><div class="hr-t">${String(hd.getHours()).padStart(2,'0')}:00</div><div class="hr-i">${wmoIcon(hourly.weather_code[idx],hDay)}</div><div class="hr-tmp">${Math.round(hourly.temperature_2m[idx])}¬∞</div><div class="hr-rain">${rain>0?rain+'%üíß':'‚Äî'}</div></div>`;
    }).join('');
    // 7-day forecast ‚Äî evenly fills height
    const loT=Math.min(...daily.temperature_2m_min.slice(0,7)),hiT=Math.max(...daily.temperature_2m_max.slice(0,7)),rng=hiT-loT||1;
    document.getElementById('fc-list').innerHTML=daily.weather_code.slice(0,7).map((code,i)=>{
      const date=new Date(daily.sunrise[i]),dayName=i===0?'Today':SDAYS[date.getDay()];
      const lo=Math.round(daily.temperature_2m_min[i]),hi=Math.round(daily.temperature_2m_max[i]);
      const left=((lo-loT)/rng*75).toFixed(1),w=(((hi-lo)/rng*75)||4).toFixed(1);
      return `<div class="fc-r"><div class="fc-day">${dayName}</div><div class="fc-ico">${wmoIcon(code,true)}</div><div class="fc-bw"><div class="fc-lo">${lo}¬∞</div><div class="fc-bg"><div class="fc-fill" style="left:${left}%;width:${w}%"></div></div><div class="fc-hi">${hi}¬∞</div></div></div>`;
    }).join('');
  }catch(e){console.error('Weather',e);}
}
fetchWeather();setInterval(fetchWeather,10*60*1000);

// MOON
function moonPhase(date=new Date()){
  const L=29.53058867,known=new Date('2000-01-06T18:14:00Z');
  const age=((((date-known)/(864e5))%L)+L)%L;
  const pct=Math.round((Math.cos((age/L)*2*Math.PI)*-0.5+0.5)*100);
  const phases=[{n:'New Moon',e:'üåë',max:1.85},{n:'Waxing Crescent',e:'üåí',max:7.38},{n:'First Quarter',e:'üåì',max:11.08},{n:'Waxing Gibbous',e:'üåî',max:14.77},{n:'Full Moon',e:'üåï',max:16.61},{n:'Waning Gibbous',e:'üåñ',max:22.15},{n:'Last Quarter',e:'üåó',max:25.84},{n:'Waning Crescent',e:'üåò',max:29.53}];
  const ph=phases.find(p=>age<=p.max)||phases[0];
  const nk=[0,7.38,14.77,22.15],nn=['New Moon','First Quarter','Full Moon','Last Quarter'];
  const na=nk.find(a=>a>age)??(L+nk[0]);
  return{name:ph.n,emoji:ph.e,pct,age:Math.round(age),daysLeft:Math.round(na>age?na-age:L-age+nk[0]),nextName:nn[nk.indexOf(na)]??'New Moon'};
}
function renderMoon(){const m=moonPhase();document.getElementById('moon-vis').textContent=m.emoji;document.getElementById('moon-name').textContent=m.name;document.getElementById('moon-pct').textContent=`Illumination ${m.pct}% ¬∑ Day ${m.age}`;document.getElementById('moon-next').textContent=`Next: ${m.nextName} in ${m.daysLeft}d`;}
renderMoon();setInterval(renderMoon,3600000);

// CALENDAR
let calY=new Date().getFullYear(),calM=new Date().getMonth();
function moonEventsInMonth(y,m){
  const L=29.53058867,known=new Date('2000-01-06T18:14:00Z'),days=new Date(y,m+1,0).getDate(),ev={};
  for(let d=1;d<=days;d++){
    const cur=new Date(y,m,d,12),prev=new Date(y,m,d-1,12);
    const age=((((cur-known)/(864e5))%L)+L)%L,pAge=((((prev-known)/(864e5))%L)+L)%L;
    if((pAge>27&&age<2)||(pAge>age&&age<1))ev[d]='üåë';
    if(pAge<14.77&&age>=14.77&&age<16)ev[d]='üåï';
  }
  return ev;
}
function renderCal(){
  const today=new Date();
  document.getElementById('cal-month').textContent=`${MONTHS[calM]} ${calY}`;
  const ev=moonEventsInMonth(calY,calM),firstDow=(new Date(calY,calM,1).getDay()+6)%7,dim=new Date(calY,calM+1,0).getDate(),prev=new Date(calY,calM,0).getDate();
  let h=['M','T','W','T','F','S','S'].map(d=>`<div class="cal-dow">${d}</div>`).join('');
  for(let i=firstDow-1;i>=0;i--)h+=`<div class="cal-day other"><div class="cn">${prev-i}</div></div>`;
  for(let d=1;d<=dim;d++){
    const date=new Date(calY,calM,d),isToday=d===today.getDate()&&calM===today.getMonth()&&calY===today.getFullYear();
    const cls=['cal-day',isToday?'today':'',isBH(date)?'bh':''].filter(Boolean).join(' ');
    h+=`<div class="${cls}"><div class="cn">${d}</div>${ev[d]?`<div class="cd">${ev[d]}</div>`:''}</div>`;
  }
  document.getElementById('cal-grid').innerHTML=h;
}
renderCal();
document.getElementById('cal-prev').addEventListener('click',()=>{calM--;if(calM<0){calM=11;calY--;}renderCal();});
document.getElementById('cal-next').addEventListener('click',()=>{calM++;if(calM>11){calM=0;calY++;}renderCal();});

// TRAINS ‚Äî reads from trains.json generated by GitHub Actions
const TRAINS_JSON = 'https://raw.githubusercontent.com/kuraishii/home-dashboard/main/trains.json';

async function tryTrainFetch(){
  if(!WORKER_URL){return '__no_worker__';}
  try{
    const res=await fetch(WORKER_URL,{
      method:'POST',
      headers:{'Content-Type':'text/xml;charset=UTF-8'},
      body:TRAIN_SOAP,
      signal:AbortSignal.timeout(8000)
    });
    if(!res.ok)return null;
    const txt=await res.text();
    return txt.includes('GetStationBoardResult')?txt:null;
  }catch(e){console.error('Train fetch failed:',e.message);return null;}
}

function parseAndRenderTrains(txt){
  const doc=new DOMParser().parseFromString(txt,'text/xml');
  const svcs=doc.querySelectorAll('trainServices service');
  if(!svcs.length){document.getElementById('train-list').innerHTML='<span style="color:var(--dim);font-size:12px">No departures</span>';return;}
  const rows=[...svcs].slice(0,8).map(svc=>{
    const g=tag=>svc.getElementsByTagNameNS('*',tag)[0]?.textContent.trim()||'';
    const aimed=g('std')||'--:--',exp=g('etd')||'On time',dest=g('locationName'),plat=g('platform');
    const cps=[...svc.querySelectorAll('callingPointList callingPoint')].map(cp=>cp.getElementsByTagNameNS('*','locationName')[0]?.textContent||'');
    const isCannon=dest.includes('Cannon')||cps.some(n=>n.includes('Cannon'));
    const isBridge=!isCannon&&(dest.includes('London Bridge')||cps.some(n=>n.includes('London Bridge')));
    const cancelled=exp.toLowerCase()==='cancelled';
    const statusCls=cancelled?'cancelled':exp!=='On time'&&exp!=='No report'&&exp!==aimed?'delayed':'on-time';
    const destCls=isCannon?'cannon':isBridge?'bridge':'';
    const prefix=isCannon?'‚òÖ ':isBridge?'‚óÜ ':'';
    return `<div class="tr"><div class="tr-time">${aimed}</div><div class="tr-dest ${destCls}">${prefix}${dest}</div><div class="tr-plat">${plat?'P'+plat:''}</div><div class="tr-status ${statusCls}">${cancelled?'Cancelled':exp}</div></div>`;
  }).join('');
  document.getElementById('train-list').innerHTML=rows;
  document.getElementById('train-upd').textContent=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
}

async function fetchTrains(){
  document.getElementById('train-list').innerHTML='<span style="color:var(--dim);font-size:12px">Loading‚Ä¶</span>';
  const txt=await tryTrainFetch();
  if(txt==='__no_worker__'){
    document.getElementById('train-list').innerHTML='<span style="color:#fbbf24;font-size:11px">‚ö† Needs Cloudflare Worker ‚Äî see setup instructions</span>';
  } else if(txt){
    parseAndRenderTrains(txt);
  } else {
    document.getElementById('train-list').innerHTML='<span style="color:#f87171;font-size:12px">‚ö† Could not reach train API</span>';
  }
}
fetchTrains();setInterval(fetchTrains,60000);

// SPOTIFY (Web Playback SDK + PKCE)
let spT={a:null,r:null,e:0},spP=null,spS=null;
function rnd(n){const a=new Uint8Array(n);crypto.getRandomValues(a);return Array.from(a,b=>b.toString(16).padStart(2,'0')).join('')}
async function sha(s){return await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s))}
function b64u(b){return btoa(String.fromCharCode(...new Uint8Array(b))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}

window.spLogin=async function(){
  const v=rnd(64),ch=b64u(await sha(v));
  document.cookie=`sp_v=${v};max-age=600;path=/;SameSite=Lax`;
  window.location.href='https://accounts.spotify.com/authorize?'+new URLSearchParams({client_id:C.spId,response_type:'code',redirect_uri:C.spRedirect,scope:C.spScopes,code_challenge_method:'S256',code_challenge:ch,state:rnd(16)});
};
async function spEx(code){
  const ck=document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('sp_v='));
  if(!ck)return false;
  try{
    const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:C.spId,grant_type:'authorization_code',code,redirect_uri:C.spRedirect,code_verifier:ck.split('=')[1]})});
    const d=await r.json();
    if(d.access_token){spT={a:d.access_token,r:d.refresh_token,e:Date.now()+d.expires_in*1000};document.cookie='sp_v=;max-age=0;path=/';saveSp();return true;}
  }catch(e){}
  return false;
}
async function spRf(){
  if(!spT.r)return false;
  try{
    const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:C.spId,grant_type:'refresh_token',refresh_token:spT.r})});
    const d=await r.json();
    if(d.access_token){spT.a=d.access_token;spT.e=Date.now()+d.expires_in*1000;if(d.refresh_token)spT.r=d.refresh_token;saveSp();return true;}
  }catch(e){}
  return false;
}
function saveSp(){if(spT.a){localStorage.setItem('sp_a',spT.a);localStorage.setItem('sp_r',spT.r||'');localStorage.setItem('sp_e',spT.e);}}
function loadSp(){const a=localStorage.getItem('sp_a'),r=localStorage.getItem('sp_r'),e=localStorage.getItem('sp_e');if(a&&e&&Date.now()<Number(e)){spT={a,r,e:Number(e)};return true;}return false;}
setInterval(async()=>{if(spT.a&&spT.e-Date.now()<120000){await spRf();}},60000);

function initSpSDK(){
  const s=document.createElement('script');s.src='https://sdk.scdn.co/spotify-player.js';document.body.appendChild(s);
  window.onSpotifyWebPlaybackSDKReady=()=>{
    spP=new Spotify.Player({name:'üè† Home Dashboard',getOAuthToken:async cb=>{if(spT.e-Date.now()<60000)await spRf();cb(spT.a);},volume:0.5});
    spP.addListener('ready',({device_id})=>console.log('Spotify ready',device_id));
    spP.addListener('player_state_changed',s=>{spS=s;rSp(s);});
    spP.addListener('authentication_error',async()=>{if(!await spRf())rSpL();});
    spP.connect();rSp(null);
  };
}
function rSp(s){
  const el=document.getElementById('spB');
  if(!s||!s.track_window?.current_track){
    el.innerHTML=`<div class="sw"><div class="sc"><div class="sph">üéµ</div></div><div class="sif"><div class="str" style="opacity:.3">Waiting for playback</div><div class="sar" style="margin-top:4px">Open Spotify ‚Üí select "üè† Home Dashboard"</div></div></div>`;
    return;
  }
  const t=s.track_window.current_track,img=t.album.images?.[0]?.url||'',p=s.duration?(s.position/s.duration*100):0;
  el.innerHTML=`<div class="sw"><div class="sc">${img?`<img src="${img}">`:'<div class="sph">üéµ</div>'}</div><div class="sif"><div class="str">${t.name}</div><div class="sar">${t.artists.map(a=>a.name).join(', ')} ‚Äî ${t.album.name}</div><div class="scr"><button class="sb" onclick="spP.previousTrack()">‚èÆ</button><button class="sb pp" onclick="spP.togglePlay()">${s.paused?'‚ñ∂':'‚è∏'}</button><button class="sb" onclick="spP.nextTrack()">‚è≠</button></div></div></div><div class="spr"><div class="spf" style="width:${p.toFixed(1)}%"></div></div>`;
}
function rSpL(){document.getElementById('spB').innerHTML=`<div class="sw"><div class="sc"><div class="sph">üéµ</div></div><div class="sif"><div class="str" style="opacity:.35">Connect Spotify</div><div class="sar">Premium required</div><span class="sli" onclick="spLogin()">Log in with Spotify</span></div></div>`;}

// Progress bar tick
setInterval(()=>{
  if(spS&&!spS.paused){
    spS.position=Math.min(spS.position+1000,spS.duration);
    const el=document.querySelector('.spf');if(el)el.style.width=`${(spS.position/spS.duration*100).toFixed(1)}%`;
  }
},1000);

// Init
(async()=>{
  const p=new URLSearchParams(window.location.search),code=p.get('code');
  if(code){window.history.replaceState({},'',window.location.pathname);if(await spEx(code)){initSpSDK();return;}}
  if(loadSp()){initSpSDK();return;}
  rSpL();
})();
</script>
</body>
</html>
